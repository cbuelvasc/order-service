name: Deployment Project

on:
    push:
      branches:
        - master
        - develop
    pull_request:
      branches:
        - master
        - develop

# Permisos necesarios para GitHub Actions
permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.13'        

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4        
        
      - name: Run Spring Boot Test Suite
        id: test-suite
        uses: cbuelvasc/actions/spring-boot-test-suite@master
        with:
          java-version: ${{ env.JAVA_VERSION }}
          java-distribution: 'temurin'
          build-tool: 'gradle'
          coverage-enabled: 'true'
          coverage-threshold: '60'
          fail-on-coverage-threshold: 'false'
          spring-profiles: 'test'
          parallel-tests: 'true'
          integration-tests: 'true'
          gradle-args: '--no-daemon --parallel --build-cache'
          jvm-args: '-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200'
          cache-enabled: 'true'
          publish-test-results: 'false'
          
      - name: Build Application (without tests)
        run: ./gradlew build -x test --no-daemon
        env:
          GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true"
          
      - name: Display Test Results Summary
        run: |
          echo "ğŸ§ª Test Results Summary:"
          echo "âœ… Test execution result: ${{ steps.test-suite.outputs.test-result }}"
          echo "ğŸ“Š Total tests executed: ${{ steps.test-suite.outputs.test-count }}"
          echo "âŒ Failed tests: ${{ steps.test-suite.outputs.failed-test-count }}"
          echo "ğŸ“ˆ Code coverage: ${{ steps.test-suite.outputs.coverage-percentage }}%"
          echo "ğŸ—‚ï¸ Cache hit: ${{ steps.test-suite.outputs.cache-hit }}"
          echo "ğŸ”§ Build tool version: ${{ steps.test-suite.outputs.build-tool-version }}"
          
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            build/reports/tests/test/
            build/reports/jacoco/
          retention-days: 7