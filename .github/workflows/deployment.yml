name: Deployment Project

on:
    push:
      branches:
        - master
        - develop
    pull_request:
      branches:
        - master
        - develop

env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.13'        

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4        
        
      - name: Setup Java & Gradle Environment
        uses: cbuelvasc/actions/setup-java-gradle-env@master
        with:
          java-version: ${{ env.JAVA_VERSION }}
          java-distribution: 'temurin'
          gradle-version: ${{ env.GRADLE_VERSION }}
          cache-strategy: 'all'
          jvm-args: '-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200'
          spring-profiles: 'test'
          gradle-args: '--no-daemon --parallel'
          
      - name: Download Dependencies
        run: ./gradlew dependencies --no-daemon
        env:
          GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true"
          
      - name: Run Tests with Coverage
        run: ./gradlew test jacocoTestReport --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true"
          
      - name: Build Application
        run: ./gradlew build -x test --no-daemon
        env:
          GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true"